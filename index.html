<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Volume + Structure Probability Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --bg:#0f1720;
  --panel:#0b1220;
  --border:#172033;
  --muted:#9fb3cc;
  --bull:#22c55e;
  --bear:#fb7185;
  --neutral:#facc15;
  --accent:#38bdf8;
}

body{
  font-family:Inter,system-ui,Arial;
  background:var(--bg);
  color:#e6eef8;
  margin:16px;
}

h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin:16px 0 8px}

.muted{color:var(--muted);font-size:13px}

button,input,select{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:var(--panel);
  color:#e6eef8;
}

button.primary{
  background:var(--bull);
  border:0;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.primary:disabled{
  opacity:.5;
  cursor:not-allowed;
}

button.secondary{
  background:#334155;
  border:0;
}

.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:12px;
}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  position:relative;
  transition:transform .15s ease, box-shadow .15s ease;
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(0,0,0,.6);
}

.bull{color:var(--bull)}
.bear{color:var(--bear)}
.neutral{color:var(--neutral)}
.prob{font-weight:700;margin-top:4px}

.star{
  position:absolute;
  top:8px; right:8px;
  cursor:pointer;
  font-size:16px;
}
.close{
  position:absolute;
  top:8px; left:8px;
  cursor:pointer;
  color:var(--bear);
}

.progress{
  height:10px;
  background:var(--border);
  border-radius:6px;
  overflow:hidden;
  margin:8px 0 14px;
}
.progress > div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--bull),#4ade80);
  transition:width .2s linear;
}

.filter-box{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
}
</style>
</head>

<body>

<h1>üìä 15m Volume ‚Üí Structure Probability Scanner</h1>
<div class="muted">Dominant volume + structure confirmation only</div>
<div class="muted">
  Last update: <span id="timestamp">‚Äî</span><br>
  Next scan in: <span id="nextScan">‚Äî</span>
</div>

<div class="row">
  <button class="primary" id="scanBtn" onclick="runScan()">Run Scan</button>
  <input id="symbolSearch" placeholder="BTCUSDT"/>
  <button class="secondary" onclick="runSearch()">Analyze</button>
</div>

<div class="row filter-box">
  <select id="filterBias">
    <option value="all">All Bias</option>
    <option>Bullish Continuation</option>
    <option>Bullish Defense</option>
    <option>Bearish Continuation</option>
    <option>Bearish Defense</option>
  </select>

  <select id="filterVol">
    <option value="all">All Volume</option>
    <option value="bull">Bull Volume</option>
    <option value="bear">Bear Volume</option>
  </select>

  <select id="filterProb">
    <option value="0">Any Prob</option>
    <option value="60">‚â• 60%</option>
    <option value="70">‚â• 70%</option>
    <option value="80">‚â• 80%</option>
  </select>
</div>

<div class="progress"><div id="progressFill"></div></div>

<h2>‚≠ê Favorites</h2>
<div class="grid" id="favGrid"></div>

<h2>üîç Manual</h2>
<div class="grid" id="searchGrid"></div>

<h2>üü¢ Top Gainers</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Top Losers</h2>
<div class="grid" id="redGrid"></div>

<script>
/* ================= CONFIG ================= */
const API="https://fapi.binance.com";
const DELAY=300;
const AUTO_INTERVAL=60*1000;

const BLACKSET=new Set([
"ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT",
"LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT",
"OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT",
"NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","MEMEFIUSDT",
"NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT",
"COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
"MYROUSDT","1000XUSDT","DARUSDT","PORT3USDT","SKATEUSDT",
"AIAUSDT","AMBUSDT","FLMUSDT","PERPUSDT","OBOLUSDT","SWELLUSDT","FTMUSDT"
]);

const favSet=new Set();
let nextScanAt=null;
let countdownTimer=null;
let scanLock=false;
let autoEnabled=true;
  let isAutoScan = false;
let autoTimer = null;
  let activeSearchSymbol = null;

const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fetchJSON=async u=>(await fetch(u)).json();

/* ================= COUNTDOWN ================= */
function startCountdown(){
  clearInterval(countdownTimer);
  countdownTimer=setInterval(()=>{
    if(!nextScanAt) return;
    const d=nextScanAt-Date.now();
    if(d<=0){
      nextScan.innerText="Ready";
      return;
    }
    const m=Math.floor(d/60000);
    const s=Math.floor((d%60000)/1000);
    nextScan.innerText=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  },1000);
}

/* ================= AUTO REFRESH ================= */
function startAutoScan(){
  if(autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(async ()=>{
    if(scanLock) return;
    isAutoScan = true;
    await runScan();
  }, AUTO_INTERVAL);
}

  window.onload = async () => {
  nextScanAt = Date.now() + AUTO_INTERVAL;
  startCountdown();
  startAutoScan();

  // üî• run first scan immediately
  isAutoScan = true;
  await runScan();
};

/* === IMPROVED 15m SWING DETECTION (CONFIRMED) === */
function findSwings(h, l, c, v){
  const supports = [];
  const resistances = [];

  // parameters (tunable but safe defaults)
  const LOOKBACK = 2;          // candles on each side
  const CONFIRM = 2;           // candles to confirm reaction
  const VOL_MULT = 1.2;        // volume must be above average

  const avgVol = v.slice(-40).reduce((a,b)=>a+b,0) / 40;

  for(let i = LOOKBACK; i < h.length - CONFIRM; i++){

    /* === SWING LOW (SUPPORT) === */
    let isSwingLow = true;
    for(let j = 1; j <= LOOKBACK; j++){
      if(l[i] >= l[i-j] || l[i] >= l[i+j]){
        isSwingLow = false;
        break;
      }
    }

    if(isSwingLow){
      // confirmation: price must move away upward
      let confirmed = true;
      for(let k = 1; k <= CONFIRM; k++){
        if(c[i+k] <= c[i]){
          confirmed = false;
          break;
        }
      }

      // volume filter (defense)
      if(confirmed && v[i] >= avgVol * VOL_MULT){
        supports.push(l[i]);
      }
    }

    /* === SWING HIGH (RESISTANCE) === */
    let isSwingHigh = true;
    for(let j = 1; j <= LOOKBACK; j++){
      if(h[i] <= h[i-j] || h[i] <= h[i+j]){
        isSwingHigh = false;
        break;
      }
    }

    if(isSwingHigh){
      // confirmation: price must move away downward
      let confirmed = true;
      for(let k = 1; k <= CONFIRM; k++){
        if(c[i+k] >= c[i]){
          confirmed = false;
          break;
        }
      }

      // volume filter (supply)
      if(confirmed && v[i] >= avgVol * VOL_MULT){
        resistances.push(h[i]);
      }
    }
  }

  return {
    supports: supports.slice(-2).reverse(),       // S1, S2
    resistances: resistances.slice(-2).reverse()  // R1, R2
  };
}

  function scoreStructure(levels, price, closes, volumes){
  let score = 0;
  const TOL = 0.003;

  const recentCloses = closes.slice(-30);
  const avgVol =
    volumes.slice(-30).reduce((a,b)=>a+b,0) / 30;

  for(const lvl of levels){
    let touches = 0;
    let defended = 0;

    for(let i=0;i<recentCloses.length;i++){
      const dist = Math.abs(recentCloses[i] - lvl) / lvl;

      if(dist < TOL){
        touches++;
        if(
          (recentCloses[i] > lvl && price > lvl) ||
          (recentCloses[i] < lvl && price < lvl)
        ){
          defended++;
        }
      }
    }

    if(touches >= 2) score++;
    if(defended >= 2) score++;
    if(defended >= 3) score++;

    if(volumes.at(-1) > avgVol * 1.1) score++;
  }

  return score;
  }

  function structureLabel(score, type){
  if(score >= 4) return `strong ${type}`;
  if(score >= 2) return `moderate ${type}`;
  if(score >= 1) return `weak ${type}`;
  return `unconfirmed ${type}`;
  }
  

/* ================= ANALYZE ================= */
async function analyze(sym,change){
  const k=await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=240`);
  await sleep(DELAY);

  const c=k.map(x=>+x[4]),h=k.map(x=>+x[2]),l=k.map(x=>+x[3]),v=k.map(x=>+x[5]);
  const price=c.at(-1);

  let domV=0,bull=true;
  for(let i=k.length-96;i<k.length;i++){
    if(v[i]>domV){domV=v[i];bull=k[i][4]>k[i][1];}
  }

    /* === Structure Levels === */
  const swings = findSwings(h,l,c,v);
const sw = {
  S: swings.supports || [],
  R: swings.resistances || []
};
  const sb=sw.S.some(x=>price<x);
  const rb=sw.R.some(x=>price>x);

    /* === Structure Scores === */
  const supportStrength = structureLabel(supportScore, "support");
  const resistanceStrength = structureLabel(resistanceScore, "resistance");

    /* === Structure Action === */
  let bias="Neutral",prob=50,structure="none";
  if(bull){
    if(rb){bias="Bullish Continuation";prob=85;structure="resistance broken";}
    else if(sw.S.length){bias="Bullish Defense";prob=70;structure="support holding";}
    else{bias="Bull Trap Risk";prob=40;}
  }else{
    if(sb){bias="Bearish Continuation";prob=85;structure="support broken";}
    else if(sw.R.length){bias="Bearish Defense";prob=70;structure="resistance failed";}
    else{bias="Bear Trap Risk";prob=40;}
  }

  /* === Bias & Probability === */
  let bias = "Neutral";
  let prob = 50;

  if(bull){
    if(resistanceBroken){
      bias = "Bullish Continuation";
      prob = 70 + Math.min(resistanceScore * 3, 15);
    }
    else if(supportScore > 0){
      bias = "Bullish Defense";
      prob = 60 + Math.min(supportScore * 3, 15);
    }
    else{
      bias = "Bull Trap Risk";
      prob = 40;
    }
  }
  else{
    if(supportBroken){
      bias = "Bearish Continuation";
      prob = 70 + Math.min(supportScore * 3, 15);
    }
    else if(resistanceScore > 0){
      bias = "Bearish Defense";
      prob = 60 + Math.min(resistanceScore * 3, 15);
    }
    else{
      bias = "Bear Trap Risk";
      prob = 40;
    }
  }

  return {sym,price,change,bull,prob,bias,structure,S:sw.S,R:sw.R,
          supportStrength,resistanceStrength,};
}

   

/* ================= FILTERS ================= */
function applyFilters(){
  const b=filterBias.value;
  const v=filterVol.value;
  const p=+filterProb.value;
  document.querySelectorAll(".card").forEach(c=>{
    let ok=true;
    if(b!=="all"&&c.dataset.bias!==b) ok=false;
    if(v!=="all"&&c.dataset.vol!==v) ok=false;
    if(p>0&&+c.dataset.prob<p) ok=false;
    c.style.display=ok?"":"none";
  });
}
filterBias.onchange=filterVol.onchange=filterProb.onchange=applyFilters;

/* ================= RENDER ================= */
function renderCard(d, el, isFav=false){
  const scope = el.id || "global";
const id = `card-${scope}-${d.sym}`;
  let card = document.getElementById(id);

  // create only once
  if(!card){
    card = document.createElement("div");
    card.id = id;
    card.className = "card";
    el.appendChild(card);
  }

  card.dataset.bias = d.bias;
  card.dataset.vol  = d.bull ? "bull" : "bear";
  card.dataset.prob = d.prob;

  card.innerHTML = `
    ${isFav
      ? `<div class="close" onclick="removeFav('${d.sym}')">‚úñ</div>`
      : `<div class="star" onclick="addFav('${d.sym}')">‚≠ê</div>`
    }
    <b>${d.sym}</b>
    <div class="muted">Price: ${d.price.toFixed(4)}</div>
    <div class="muted ${d.change>=0?"bull":"bear"}">
      24h Change: ${d.change.toFixed(2)}%
    </div>
    
    <div class="muted ${d.bull?"bull":"bear"}">
      ${d.bull?"Bullish":"Bearish"} Volume Control
    </div>

      <!-- STRUCTURE ACTION -->
    <div class="muted">Structure: ${d.structure}</div>
    
      <!-- BIAS & PROBABILITY -->
    <div class="prob ${
      d.bias.includes("Bull")?"bull":
      d.bias.includes("Bear")?"bear":"neutral"
    }">
      ${d.bias} ‚Äî ${d.prob}%
    </div>
    
       <!-- STRUCTURE STRENGTH -->
    ${d.supportStrength
      ? `<div class="muted bear">Support: ${d.supportStrength}</div>`
      : ""
    }

    ${d.resistanceStrength
      ? `<div class="muted bull">Resistance: ${d.resistanceStrength}</div>`
      : ""
    }

      <!-- LEVELS -->
    ${d.S[0]?`<div class="muted bear">S1: ${d.S[0].toFixed(4)}</div>`:""}
    ${d.S[1]?`<div class="muted bear">S2: ${d.S[1].toFixed(4)}</div>`:""}
    ${d.R[0]?`<div class="muted bull">R1: ${d.R[0].toFixed(4)}</div>`:""}
    ${d.R[1]?`<div class="muted bull">R2: ${d.R[1].toFixed(4)}</div>`:""}
  `;

  applyFilters();
}

/* ================= FAVORITES ================= */
async function addFav(sym){
  if(BLACKSET.has(sym)) return;
  favSet.add(sym);
  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${sym}`);
  const d=await analyze(sym,+t.priceChangePercent);
  renderCard(d,favGrid,true);
}
function removeFav(sym){
  favSet.delete(sym);
  favGrid.innerHTML="";
  favSet.forEach(addFav);
}

/* ================= SCAN ================= */
async function runScan(){
  if(scanLock) return;
  scanLock = true;
  scanBtn.disabled = true;

  // ‚ùó reset ONLY on manual scan
  if(!isAutoScan){
    greenGrid.innerHTML = "";
    redGrid.innerHTML = "";
    progressFill.style.width = "0%";
  }

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt = t.filter(x=>x.symbol.endsWith("USDT") && !BLACKSET.has(x.symbol));

  const g = [...usdt].sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const r = [...usdt].sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);
  const all = [...g, ...r];

  let done = 0;
  for(const x of all){
    const d = await analyze(x.symbol, +x.priceChangePercent);
    renderCard(d, x.priceChangePercent>=0 ? greenGrid : redGrid);
    done++;
    progressFill.style.width = Math.round(done/all.length*100)+"%";
    await sleep(120); // rate-limit safety
  }

  // üîÑ auto-update search result if active
if(activeSearchSymbol){
  try{
    const t = await fetchJSON(
      `${API}/fapi/v1/ticker/24hr?symbol=${activeSearchSymbol}`
    );
    const d = await analyze(activeSearchSymbol, +t.priceChangePercent);
    renderCard(d, searchGrid);
  }catch(e){
    console.warn("Search auto-update failed", e);
  }
}

  timestamp.innerText = new Date().toLocaleString();
  nextScanAt = Date.now() + AUTO_INTERVAL;
  startCountdown();

  scanLock = false;
  scanBtn.disabled = false;
  isAutoScan = false;
}

/* ================= SEARCH ================= */
async function runSearch(){
  const s = symbolSearch.value.toUpperCase();
  if(!s) return;

  const sym = s.endsWith("USDT") ? s : s + "USDT";
  if(BLACKSET.has(sym)) return;

  activeSearchSymbol = sym;   // ‚úÖ remember search
  searchGrid.innerHTML = "";

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${sym}`);
  const d = await analyze(sym, +t.priceChangePercent);

  renderCard(d, searchGrid);
  timestamp.innerText = new Date().toLocaleString();
}
</script>
</body>
</html>
