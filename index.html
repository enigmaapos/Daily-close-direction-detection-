<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>1D Bull / Bear Probability ‚Äî Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#334155;
  border:0;
  cursor:pointer;
}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:12px;
  margin-top:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.vol-high{color:#22c55e}
.vol-mid{color:#facc15}
.vol-low{color:#fb7185}
.prob{font-weight:700}
</style>
</head>
<body>

<h1>üìä Daily Bull / Bear Probability ‚Äî Pro Scanner</h1>
<div class="muted" id="status">Idle</div>

<div class="row">
  <button class="primary" onclick="runScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto Refresh Top Movers</button>
  <div class="muted" id="timestamp"></div>
</div>

<div class="row">
  <input id="symbolSearch" placeholder="Search symbol (BTCUSDT)" />
  <button class="secondary" onclick="runSearch()">Analyze</button>
  <button class="secondary" onclick="toggleSearchAuto()">Auto Refresh Search</button>
</div>

<h2>üü¢ Top 30 GREEN</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Top 30 RED</h2>
<div class="grid" id="redGrid"></div>

<h2>üîç Manual Symbol</h2>
<div class="grid" id="searchGrid"></div>

<script>
/* ================= CONFIG ================= */
const API = 'https://fapi.binance.com';
const DELAY = 300;

/* ================= CACHE ================= */
const vol15mCache = {}; // { sym: {cur,max,ratio,cls,label,ts} }

/* ================= HELPERS ================= */
const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("Fetch failed");
  return r.json();
}

function formatNum(n){
  return Number(n).toLocaleString(undefined,{maximumFractionDigits:0});
}

/* ================= 15M VOLUME (24H SESSION) ================= */

async function get15mSessionVolume(sym){
  if(vol15mCache[sym] && Date.now() - vol15mCache[sym].ts < 60_000){
    return vol15mCache[sym];
  }

  const k15 = await fetchJSON(
    `${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=96`
  );
  await sleep(DELAY);

  const vols = k15.map(k => Number(k[5]));
  const cur = vols[vols.length - 1];
  const max = Math.max(...vols);
  const ratio = max ? cur / max : 0;

  let cls='vol-low', label='Low';
  if(ratio >= 0.9){ cls='vol-high'; label='Session High'; }
  else if(ratio >= 0.5){ cls='vol-mid'; label='Healthy'; }

  const res = {cur,max,ratio,cls,label,ts:Date.now()};
  vol15mCache[sym] = res;
  return res;
}

/* ================= ANALYSIS (UNCHANGED CORE) ================= */

async function analyze(sym,bear=false){
  const k4 = await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=4h&limit=60`);
  await sleep(DELAY);

  const c = k4.map(k=>+k[4]);
  const v = k4.map(k=>+k[5]);
  const last = k4[k4.length-1];
  const avgVol = v.slice(-20).reduce((a,b)=>a+b,0)/20;

  let score=0, reasons=[];
  if(!bear){
    if(last[4] > last[1]){score++;reasons.push("Bull Candle");}
    if(last[5] > avgVol){score++;reasons.push("Volume Confirmed");}
  }else{
    if(last[4] < last[1]){score++;reasons.push("Bear Candle");}
    if(last[5] > avgVol){score++;reasons.push("Sell Volume");}
  }

  return {
    sym,
    prob: score*20,
    bias: score>=2?(bear?"Strong Bear":"Strong Bull"):"Neutral",
    reasons
  };
}

/* ================= UI ================= */

async function renderCard(d, el){
  const biasCls = d.bias.includes("Bull")?"bull":d.bias.includes("Bear")?"bear":"neutral";
  const id = `vol-${d.sym}-${Math.random()}`;

  el.innerHTML += `
    <div class="card">
      <b>${d.sym}</b>
      <div class="muted" id="${id}">15m Vol: loading‚Ä¶</div>
      <div class="prob ${biasCls}">${d.bias} ‚Äî ${d.prob}%</div>
      <div class="muted">${d.reasons.join(" ‚Ä¢ ")}</div>
    </div>
  `;

  try{
    const v = await get15mSessionVolume(d.sym);
    const e = document.getElementById(id);
    if(e){
      e.innerHTML =
        `15m Vol: ${formatNum(v.cur)} / ${formatNum(v.max)}
         <span class="${v.cls}">(${v.label})</span>`;
    }
  }catch{}
}

/* ================= SCANS ================= */

async function runScan(){
  greenGrid.innerHTML=''; redGrid.innerHTML='';
  status.innerText='Scanning‚Ä¶';

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt = t.filter(x=>x.symbol.endsWith("USDT"));

  const green = [...usdt].sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const red   = [...usdt].sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);

  for(const x of green){
    const r = await analyze(x.symbol,false);
    await renderCard(r,greenGrid);
  }

  for(const x of red){
    const r = await analyze(x.symbol,true);
    await renderCard(r,redGrid);
  }

  timestamp.innerText = "Updated: "+new Date().toLocaleString();
  status.innerText = "Completed";
}

async function runSearch(){
  const sym = symbolSearch.value.trim().toUpperCase();
  if(!sym.endsWith("USDT")) return;
  searchGrid.innerHTML='';

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${sym}`);
  const bear = Number(t.priceChangePercent) < 0;
  const r = await analyze(sym,bear);
  await renderCard(r,searchGrid);
}

function toggleAuto(){}

/* ================= INIT ================= */
symbolSearch.addEventListener("keydown",e=>{if(e.key==="Enter")runSearch();});
</script>
</body>
</html>
