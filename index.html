<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Bull / Bear Probability ‚Äî Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:14px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:15px;margin-top:16px}
.muted{color:#9fb3cc;font-size:12px}

button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
}
button.secondary{background:#334155;border:0}
.sort-btn{background:#1e293b}

.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:10px;
  position:relative;
}

.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.prob{font-weight:700}

.star{cursor:pointer;font-size:15px}
.star.active{color:#facc15}

.close{
  position:absolute;
  top:6px;
  right:8px;
  cursor:pointer;
  color:#fb7185;
  font-weight:700;
}

/* üì± Compact Mobile */
@media(max-width:520px){
  .grid{grid-template-columns:1fr}
  .muted.reasons{display:none}
  .card{padding:8px}
}
</style>
</head>

<body>

<h1>üìä Multi-TF Bull / Bear Confidence ‚Äî Pro</h1>
<div class="muted" id="status">Idle</div>

<div class="row">
  <button class="primary" onclick="runScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto</button>
  <div class="muted" id="timestamp"></div>
</div>

<div class="row">
  <input id="symbolSearch" placeholder="BTCUSDT"/>
  <button class="secondary" onclick="runSearch()">Analyze</button>
</div>

<div class="row">
  <button class="sort-btn" onclick="toggleSort('confidence')">Sort Conf</button>
  <button class="sort-btn" onclick="toggleSort('drawdown')">Sort DD</button>
  <button class="sort-btn" onclick="toggleSort('sym')">Sort Sym</button>
</div>

<h2>‚≠ê Favorites (Pinned)</h2>
<div class="grid" id="favGrid"></div>

<h2>üü¢ Strong Bullish</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Strong Bearish</h2>
<div class="grid" id="redGrid"></div>

<h2>üîç Manual</h2>
<div class="grid" id="searchGrid"></div>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ========== STATE ========== */
const API="https://fapi.binance.com";
const AUTO_INTERVAL=5*60*1000;
let autoTimer=null;

let sortKey="confidence", sortDir="desc";
let greenData=[], redData=[];
let favorites=JSON.parse(localStorage.getItem("favorites")||"{}");

/* ========== DOM ========== */
const greenGrid=greenGrid=document.getElementById("greenGrid");
const redGrid=document.getElementById("redGrid");
const favGrid=document.getElementById("favGrid");
const searchGrid=document.getElementById("searchGrid");
const alertSound=document.getElementById("alertSound");
const status=document.getElementById("status");
const timestamp=document.getElementById("timestamp");
const symbolSearch=document.getElementById("symbolSearch");

/* ========== HELPERS ========== */
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fetchJSON=async u=>(await fetch(u)).json();

function ema(v,p){
  const k=2/(p+1); let e=v[0];
  for(let i=1;i<v.length;i++) e=v[i]*k+e*(1-k);
  return e;
}
function rsi(c,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){const d=c[i]-c[i-1];d>0?g+=d:l-=d}
  let rs=g/(l||1),r=100-(100/(1+rs));
  for(let i=p+1;i<c.length;i++){
    const d=c[i]-c[i-1];
    if(d>0){g=(g*(p-1)+d)/p;l=(l*(p-1))/p}
    else{g=(g*(p-1))/p;l=(l*(p-1)-d)/p}
    rs=g/(l||1); r=100-(100/(1+rs));
  }
  return r;
}

/* ========== TF ANALYSIS ========== */
async function tfScore(sym,tf){
  const k=await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=120`);
  const c=k.map(x=>+x[4]), v=k.map(x=>+x[5]);
  const last=k[k.length-1];
  let s=0;
  if(+last[4]>ema(c.slice(-60),50)) s++;
  if(rsi(c)>50) s++;
  if(+last[5]>(v.slice(-40).reduce((a,b)=>a+b,0)/40)) s++;
  return s/3; // normalized 0‚Äì1
}

/* ========== MASTER ANALYSIS ========== */
async function analyze(sym,bear,dd){
  const s15=await tfScore(sym,"15m");
  const s1h=await tfScore(sym,"1h");
  const s4h=await tfScore(sym,"4h");

  let confidence=Math.round((s15*0.5+s1h*0.3+s4h*0.2)*100);

  if(bear) confidence=100-confidence;
  if(dd>=-1) confidence+=5;
  if(dd<=-7) confidence-=10;

  confidence=Math.max(0,Math.min(100,confidence));

  const bias=confidence>=75?(bear?"Strong Bear":"Strong Bull"):
             confidence>=60?(bear?"Weak Bear":"Weak Bull"):
             "Neutral";

  return {sym,confidence,bias,drawdown:dd};
}

/* ========== SORT & FAVORITES ========== */
function toggleSort(k){
  if(sortKey===k) sortDir=sortDir==="asc"?"desc":"asc";
  else{sortKey=k;sortDir="desc"}
  renderAll();
}

function toggleFav(d){
  favorites[d.sym]?delete favorites[d.sym]:favorites[d.sym]=d;
  localStorage.setItem("favorites",JSON.stringify(favorites));
  renderAll();
}

function removeFav(sym){
  delete favorites[sym];
  localStorage.setItem("favorites",JSON.stringify(favorites));
  renderAll();
}

/* ========== RENDER ========== */
function card(d){
  const pc=d.bias.includes("Bull")?"bull":d.bias.includes("Bear")?"bear":"neutral";
  const fav=favorites[d.sym];
  return `
  <div class="card">
    <span class="star ${fav?'active':''}" onclick='toggleFav(${JSON.stringify(d)})'>‚≠ê</span>
    <b>${d.sym}</b>
    <div class="prob ${pc}">${d.bias} ‚Äî ${d.confidence}%</div>
    <div class="muted">DD ${d.drawdown.toFixed(2)}%</div>
  </div>`;
}

function renderAll(){
  favGrid.innerHTML="";
  Object.values(favorites).forEach(d=>{
    favGrid.innerHTML+=`
    <div class="card">
      <span class="close" onclick="removeFav('${d.sym}')">‚úñ</span>
      <b>${d.sym}</b>
      <div class="prob">${d.bias} ‚Äî ${d.confidence}%</div>
    </div>`;
  });

  const sort=(a,b)=>{
    let v1=a[sortKey],v2=b[sortKey];
    if(sortKey==="sym"){v1=a.sym;v2=b.sym}
    return sortDir==="asc"?v1-v2:v2-v1;
  };

  greenGrid.innerHTML="";
  redGrid.innerHTML="";

  [...greenData].sort(sort).forEach(d=>{
    greenGrid.innerHTML+=card(d);
    if(favorites[d.sym]&&d.confidence>=80) alertSound.play();
  });
  [...redData].sort(sort).forEach(d=>redGrid.innerHTML+=card(d));
}

/* ========== MAIN ========== */
async function runScan(){
  status.innerText="Scanning...";
  greenData=[]; redData=[];
  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt=t.filter(x=>x.symbol.endsWith("USDT"));

  for(const x of usdt.slice(0,30)){
    const dd=((+x.lastPrice-+x.highPrice)/+x.highPrice)*100;
    greenData.push(await analyze(x.symbol,false,dd));
    redData.push(await analyze(x.symbol,true,dd));
  }
  renderAll();
  timestamp.innerText=new Date().toLocaleString();
  status.innerText="Completed";
}

function toggleAuto(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null}
  else{runScan();autoTimer=setInterval(runScan,AUTO_INTERVAL)}
}

async function runSearch(){
  const sym=symbolSearch.value.trim().toUpperCase();
  if(!sym.endsWith("USDT")) return;
  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${sym}`);
  const dd=((+t.lastPrice-+t.highPrice)/+t.highPrice)*100;
  searchGrid.innerHTML=card(await analyze(sym,t.priceChangePercent<0,dd));
}

renderAll();
</script>
</body>
</html>
