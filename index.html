<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Bull / Bear Probability Daily Close Bias Scanner ‚Äî Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#334155;
  border:0;
  cursor:pointer;
}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:12px;
  margin-top:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.prob{font-weight:700}

.progress-wrap{margin:8px 0 10px}
.progress-bar{
  height:10px;
  background:#172033;
  border-radius:6px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:#22c55e;
  transition:width .2s linear;
}
</style>
</head>

<body>

<h1>üìä 15m Structure ‚Üí Daily Close Bias Scanner</h1>
<div class="muted">
  Uses 15m market structure to estimate <b>daily/session close direction</b>
</div>
<div class="muted" id="status">Idle</div>
<div class="muted" id="refreshTimer">Auto refresh: OFF</div>

<div class="progress-wrap">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="row">
  <button class="primary" onclick="manualScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto Refresh</button>
  <div class="muted" id="timestamp"></div>
</div>

<div class="row">
  <input id="symbolSearch" placeholder="Search symbol (BTCUSDT)" />
  <button class="secondary" onclick="runSearch()">Analyze</button>
</div>

  <div class="row" style="margin-top:6px">
  <select id="filterStructure">
    <option value="all">All Structures</option>
    <option value="Weak Support">Weak Support</option>
    <option value="Weak Resistance">Weak Resistance</option>
  </select>

  <select id="filterBias">
    <option value="all">All Bias</option>
    <option value="Strong Bull">Strong Bull</option>
    <option value="Weak Bull">Weak Bull</option>
    <option value="Strong Bear">Strong Bear</option>
    <option value="Weak Bear">Weak Bear</option>
    <option value="Neutral">Neutral</option>
  </select>

  <select id="filterChange">
    <option value="all">All Change</option>
    <option value="green">Green (24h +)</option>
    <option value="red">Red (24h -)</option>
  </select>

  <select id="filterProb">
    <option value="0">Any Probability</option>
    <option value="50">‚â• 50%</option>
    <option value="60">‚â• 60%</option>
    <option value="70">‚â• 70%</option>
    <option value="80">‚â• 80%</option>
  </select>
  </div>

  <div class="row">
  <label class="muted">Level State:</label>
  <select id="filterLevelState">
    <option value="all">All</option>
    <option value="valid">Valid Levels</option>
    <option value="broken">Broken Levels</option>
  </select>
  </div>

  <div class="row">
  <label class="muted">Daily Close Bias:</label>
  <select id="filterDailyClose">
    <option value="all">All</option>
    <option value="bullish">Bullish Daily Close</option>
    <option value="bearish">Bearish Daily Close</option>
    <option value="unclear">Unclear</option>
  </select>
  </div>

  <div class="row" style="margin-top:6px">
  <button class="secondary" onclick="resetFilters()">Reset Filters</button>
  </div>

  <div class="muted" style="margin-bottom:6px">
  AI highlights <b>WEAK STRUCTURE ZONES</b> where control is likely to shift:
</div>

<div class="muted bull" style="margin-bottom:2px">
  üü¢ <b>Weak Resistance</b> ‚Üí Sellers failing to defend  
  ‚Üí Break and hold above may confirm <b>bull continuation</b>  
  ‚Üí Watch for <b>resistance flipping into strong support</b>
</div>

<div class="muted bear" style="margin-bottom:8px">
  üî¥ <b>Weak Support</b> ‚Üí Buyers failing to defend  
  ‚Üí Break and hold below may confirm <b>bear continuation</b>  
  ‚Üí Watch for <b>support flipping into strong resistance</b>
</div>

  <h2>üîç Manual Analysis</h2>

<div class="grid" id="searchGrid"></div>

<h2>üü¢ Top 30 GREEN</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Top 30 RED</h2>
<div class="grid" id="redGrid"></div>


<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= DOM ================= */
const greenGrid = document.getElementById("greenGrid");
const redGrid   = document.getElementById("redGrid");
const searchGrid= document.getElementById("searchGrid");
const status    = document.getElementById("status");
const timestamp = document.getElementById("timestamp");
const symbolSearch = document.getElementById("symbolSearch");
const alertSound = document.getElementById("alertSound");
const progressFill = document.getElementById("progressFill");
const refreshTimer = document.getElementById("refreshTimer");

/* ================= CONFIG ================= */
const API = "https://fapi.binance.com";
const AUTO_INTERVAL = 60 * 1000; // 1 minute
const DELAY = 300;              // safe pacing
const MAX_SCORE = 10;

const BLACKSET = new Set([
 "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT",
  "LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT",
  "OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT",
  "NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","MEMEFIUSDT",
  "NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT",
  "COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
  "MYROUSDT","1000XUSDT","DARUSDT","PORT3USDT","SKATEUSDT",
  "AIAUSDT","AMBUSDT","FLMUSDT","PERPUSDT","OBOLUSDT","SWELLUSDT","FTMUSDT"
]);

/* ================= STATE ================= */
let autoEnabled=false, autoTimer=null, countdownTimer=null, nextRefreshAt=0;
let isAuto=false;
  let scanRunning = false;

/* ================= AUTO REFRESH ================= */
function startCountdown(){
  clearInterval(countdownTimer);
  countdownTimer=setInterval(()=>{
    const d=nextRefreshAt-Date.now();
    if(d<=0){refreshTimer.innerText="Refreshing now...";return;}
    const m=Math.floor(d/60000);
    const s=Math.floor((d%60000)/1000);
    refreshTimer.innerText=`Next refresh in: ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  },1000);
}

function toggleAuto(){
  autoEnabled=!autoEnabled;
  clearInterval(autoTimer); clearInterval(countdownTimer);
  if(autoEnabled){
    isAuto=true;
    runScan();
    nextRefreshAt=Date.now()+AUTO_INTERVAL;
    autoTimer=setInterval(()=>{
      isAuto=true;
      runScan();
      nextRefreshAt=Date.now()+AUTO_INTERVAL;
    },AUTO_INTERVAL);
    startCountdown();
  }else{
    isAuto=false;
    refreshTimer.innerText="Auto refresh: OFF";
  }
}
  

function manualScan(){
  isAuto=false;
  greenGrid.innerHTML="";
  redGrid.innerHTML="";
  searchGrid.innerHTML="";
  progressFill.style.width="0%";
  runScan();
}

  window.addEventListener("DOMContentLoaded", ()=>{
  [
    "filterStructure",
    "filterBias",
    "filterChange",
    "filterProb",
    "filterLevelState",
    "filterDailyClose" // ‚úÖ NEW
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", applyFilters);
  });
});
  

/* ================= HELPERS ================= */
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fetchJSON=async u=>(await fetch(u)).json();

function ema(v,p){const k=2/(p+1);let e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
function rsi(c,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){const d=c[i]-c[i-1];d>0?g+=d:l-=d;}
  let rs=g/(l||1), r=100-(100/(1+rs));
  for(let i=p+1;i<c.length;i++){
    const d=c[i]-c[i-1];
    if(d>0){g=(g*(p-1)+d)/p;l=(l*(p-1))/p;}
    else{g=(g*(p-1))/p;l=(l*(p-1)-d)/p;}
    rs=g/(l||1); r=100-(100/(1+rs));
  } return r;
}
function atr(h,l,c,p=14){
  let t=[];for(let i=1;i<c.length;i++)
  t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));
  return t.slice(-p).reduce((a,b)=>a+b,0)/p;
}

  /* === IMPROVED 15m SWING DETECTION (CONFIRMED) === */
function findSwings(h, l, c, v){
  const supports = [];
  const resistances = [];

  // parameters (tunable but safe defaults)
  const LOOKBACK = 2;          // candles on each side
  const CONFIRM = 2;           // candles to confirm reaction
  const VOL_MULT = 1.2;        // volume must be above average

  const avgVol = v.slice(-40).reduce((a,b)=>a+b,0) / 40;

  for(let i = LOOKBACK; i < h.length - CONFIRM; i++){

    /* === SWING LOW (SUPPORT) === */
    let isSwingLow = true;
    for(let j = 1; j <= LOOKBACK; j++){
      if(l[i] >= l[i-j] || l[i] >= l[i+j]){
        isSwingLow = false;
        break;
      }
    }

    if(isSwingLow){
      // confirmation: price must move away upward
      let confirmed = true;
      for(let k = 1; k <= CONFIRM; k++){
        if(c[i+k] <= c[i]){
          confirmed = false;
          break;
        }
      }

      // volume filter (defense)
      if(confirmed && v[i] >= avgVol * VOL_MULT){
        supports.push(l[i]);
      }
    }

    /* === SWING HIGH (RESISTANCE) === */
    let isSwingHigh = true;
    for(let j = 1; j <= LOOKBACK; j++){
      if(h[i] <= h[i-j] || h[i] <= h[i+j]){
        isSwingHigh = false;
        break;
      }
    }

    if(isSwingHigh){
      // confirmation: price must move away downward
      let confirmed = true;
      for(let k = 1; k <= CONFIRM; k++){
        if(c[i+k] >= c[i]){
          confirmed = false;
          break;
        }
      }

      // volume filter (supply)
      if(confirmed && v[i] >= avgVol * VOL_MULT){
        resistances.push(h[i]);
      }
    }
  }

  return {
    supports: supports.slice(-2).reverse(),       // S1, S2
    resistances: resistances.slice(-2).reverse()  // R1, R2
  };
}


  function detectOverallDominance({
  dominantBull,
  change,
  levelType,
  levelStrength,
  supportDistances,
  resistanceDistances,
  reasons,
  lastPrice,
  e50
}){
  let bull = 0, bear = 0;

  // Volume control
  dominantBull ? bull++ : bear++;

  // Price impulse
  if(change >= 5) bull++;
  if(change <= -5) bear++;

  // Structure weakness
  if(levelType === "Support Test" && levelStrength === "Weak Support") bear++;
  if(levelType === "Resistance Test" && levelStrength === "Weak Resistance") bull++;

  // Broken levels
  if(levelType === "Support Test" && supportDistances?.some(x => x < -0.2)) bear++;
  if(levelType === "Resistance Test" && resistanceDistances?.some(x => x < -0.2)) bull++;

  // Trend location
  if(lastPrice > e50) bull++;
  if(lastPrice < e50) bear++;

  // Acceptance / volatility
  if(reasons.includes("Acceptance Below High")) bear++;
  if(reasons.includes("Holding Highs")) bull++;

  if(reasons.includes("Volatility Expansion")){
    change < 0 ? bear++ : bull++;
  }

  if(bear >= bull + 2) return "Bear Dominant";
  if(bull >= bear + 2) return "Bull Dominant";
  return "Neutral Control";
  }


  
/* ================= ANALYSIS ================= */
async function analyze(sym, bear, dd, dChange){
  const k = await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=240`);
  await sleep(DELAY);

  const c = k.map(x=>+x[4]);
  const h = k.map(x=>+x[2]);
  const l = k.map(x=>+x[3]);
  const v = k.map(x=>+x[5]);
  const last = k[k.length-1];
  const lastPrice = +last[4];

  /* === Dominant 24h Volume === */
  let dominantVol = 0, dominantBull = true;
  for(let i=k.length-96;i<k.length;i++){
    if(v[i] > dominantVol){
      dominantVol = v[i];
      dominantBull = k[i][4] > k[i][1];
    }
  }

  /* === Indicators === */
  const avgV = v.slice(-40).reduce((a,b)=>a+b,0)/40;
  const e50  = ema(c.slice(-60),50);
  const e50p = ema(c.slice(-65,-5),50);
  const e200 = ema(c.slice(-220),200);
  const ema200Dist = ((lastPrice-e200)/e200)*100;

  const rNow  = rsi(c);
  const rPrev = rsi(c.slice(0,-1));
  const aNow  = atr(h,l,c);
  const aPrev = atr(h.slice(0,-1),l.slice(0,-1),c.slice(0,-1));
  const bodyR = Math.abs(lastPrice-last[1])/(last[2]-last[3]||1);

  /* === STRUCTURE SCORE === */
  let s = 0, rs = [];

  if(!bear){
    if(lastPrice > e50){ s++; rs.push("Above EMA50"); }
    if(e50 > e50p){ s++; rs.push("EMA Rising"); }
    if(rNow > 50){ s++; rs.push("RSI > 50"); }
    if(rNow > rPrev){ s++; rs.push("RSI Rising"); }
    if(last[5] > avgV){ s++; rs.push("Volume Expansion"); }
    if(bodyR > 0.55){ s++; rs.push("Strong Bull Candle"); }
    if(aNow > aPrev){ s++; rs.push("Volatility Expansion"); }
    if(dd > -2){ s++; rs.push("Holding Highs"); }
  }else{
    if(lastPrice < e50){ s++; rs.push("Below EMA50"); }
    if(e50 < e50p){ s++; rs.push("EMA Falling"); }
    if(rNow < 50){ s++; rs.push("RSI < 50"); }
    if(rNow < rPrev){ s++; rs.push("RSI Falling"); }
    if(last[5] > avgV){ s++; rs.push("Sell Volume"); }
    if(bodyR > 0.55){ s++; rs.push("Strong Bear Candle"); }
    if(aNow > aPrev){ s++; rs.push("Volatility Expansion"); }
    if(dd < -2){ s++; rs.push("Acceptance Below High"); }
  }

  s = Math.min(MAX_SCORE, s);
  const baseProb = Math.round((s / MAX_SCORE) * 100);

  /* === PROBABILITY ADJUSTMENT === */
  let finalProb = baseProb;
  if((!bear && dominantBull) || (bear && !dominantBull)) finalProb += 10;
  else finalProb -= 5;

  finalProb = Math.max(0, Math.min(100, finalProb));

  /* === BIAS === */
  let bias = "Neutral";
  if(!bear){
    if(finalProb >= 75) bias = "Strong Bull";
    else if(finalProb >= 55) bias = "Weak Bull";
  }else{
    if(finalProb >= 75) bias = "Strong Bear";
    else if(finalProb >= 55) bias = "Weak Bear";
  }

  /* === 15m SUPPORT / RESISTANCE LEVELS === */
  const swings = findSwings(h, l, c, v);
  const supportLevels = swings.supports;
  const resistanceLevels = swings.resistances;

  /* === DISTANCE TO LEVELS (%) === */
  const supportDistances = supportLevels.map(
    lvl => ((lastPrice - lvl) / lastPrice) * 100
  );
  const resistanceDistances = resistanceLevels.map(
    lvl => ((lvl - lastPrice) / lastPrice) * 100
  );

  /* === INTERPRETATION === */
  let levelType, levelStrength, levelText;

  if(dominantBull){
    levelType = "Support Test";
    if(finalProb >= 75){
      levelStrength = "Strong Support";
      levelText = "High-volume buying suggests strong support. Continuation favored.";
    }else if(finalProb >= 55){
      levelStrength = "Moderate Support";
      levelText = "Support likely to be tested. Watch for reaction.";
    }else{
      levelStrength = "Weak Support";
      levelText = "Support appears weak. Breakdown risk increases.";
    }
  }else{
    levelType = "Resistance Test";
    if(finalProb >= 75){
      levelStrength = "Strong Resistance";
      levelText = "Heavy selling suggests strong resistance. Rejection favored.";
    }else if(finalProb >= 55){
      levelStrength = "Moderate Resistance";
      levelText = "Resistance likely to be tested. Watch for rejection.";
    }else{
      levelStrength = "Weak Resistance";
      levelText = "Resistance appears weak. Breakout risk increases.";
    }
  }

  const overallDominant = detectOverallDominance({
  dominantBull,
  change: dChange,
  levelType,
  levelStrength,
  supportDistances,
  resistanceDistances,
  reasons: rs,
  lastPrice,
  e50
});

  return {
    sym,
    prob: finalProb,
    baseProb,
    bias,
    overallDominant,
    reasons: rs,
    dominantBull,
    dominantVol,
    ema200Dist,
    change: dChange,
    levelType,
    levelStrength,
    levelText,
    supportLevels,
    resistanceLevels,
    supportDistances,
    resistanceDistances
  };
}



            function renderCard(d, el, force = false) {

  /* === FILTER: weak structure only (unless forced search) === */
  const isWeakSupport =
    d.levelType === "Support Test" &&
    d.levelStrength === "Weak Support";

  const isWeakResistance =
    d.levelType === "Resistance Test" &&
    d.levelStrength === "Weak Resistance";

  if (!force && el.id === "searchGrid" && !isWeakSupport && !isWeakResistance) {
    return;
  }

  /* === CARD INSTANCE === */
  let card = document.getElementById(el.id + "-" + d.sym);
  if (!card) {
    card = document.createElement("div");
    card.className = "card";
    card.id = el.id + "-" + d.sym;
    el.appendChild(card);
  }

  /* === STRUCTURE BREAK (ONLY ACTIVE STRUCTURE CAN BREAK) === */
  const BREAK_TOL = -0.2;

  const supportBroken =
    d.levelType === "Support Test" &&
    d.supportDistances?.length >= 2 &&
    d.supportDistances[0] < BREAK_TOL &&
    d.supportDistances[1] < BREAK_TOL;

  const resistanceBroken =
    d.levelType === "Resistance Test" &&
    d.resistanceDistances?.length >= 2 &&
    d.resistanceDistances[0] < BREAK_TOL &&
    d.resistanceDistances[1] < BREAK_TOL;

  const levelState = (supportBroken || resistanceBroken)
    ? "broken"
    : "valid";

  /* === DAILY CLOSE BIAS (STRUCTURE > EVERYTHING) === */
  let dailyCloseBias = "Unclear";
  let dailyCloseColor = "neutral";
  let dailyCloseState = "unclear";

  // HARD STRUCTURE TRUTH
  if (supportBroken) {
    dailyCloseBias = "Bearish Daily Close (Support Broken)";
    dailyCloseColor = "bear";
    dailyCloseState = "bearish";
  }
  else if (resistanceBroken) {
    dailyCloseBias = "Bullish Daily Close (Resistance Broken)";
    dailyCloseColor = "bull";
    dailyCloseState = "bullish";
  }

  // CONTEXT ONLY IF STRUCTURE HOLDS
  else if (d.overallDominant.includes("Bull") &&
           d.levelType === "Resistance Test" &&
           d.levelStrength === "Weak Resistance") {

    dailyCloseBias = "Bullish Daily Close (Weak Resistance)";
    dailyCloseColor = "bull";
    dailyCloseState = "bullish";
  }
  else if (d.overallDominant.includes("Bear") &&
           d.levelType === "Support Test" &&
           d.levelStrength === "Weak Support") {

    dailyCloseBias = "Bearish Daily Close (Weak Support)";
    dailyCloseColor = "bear";
    dailyCloseState = "bearish";
  }

  /* === DATASET (FILTERS) === */
  card.dataset.levelState = levelState;
  card.dataset.bias = d.bias;
  card.dataset.structure = d.levelStrength;
  card.dataset.prob = d.prob;
  card.dataset.change = d.change >= 0 ? "green" : "red";
  card.dataset.dailyClose = dailyCloseState;

  /* === COLORS === */
  const biasColor =
    d.bias.includes("Bull") ? "bull" :
    d.bias.includes("Bear") ? "bear" : "neutral";

  const changeColor = d.change >= 0 ? "bull" : "bear";

  const dominantColor =
    d.overallDominant.includes("Bull") ? "bull" :
    d.overallDominant.includes("Bear") ? "bear" : "neutral";

  const activeLevelColor =
    d.levelType === "Support Test" ? "bear" :
    d.levelType === "Resistance Test" ? "bull" : "neutral";

  const volumeLabel = d.dominantBull
    ? "Bullish Volume Control"
    : "Bearish Volume Control";

  /* === RENDER === */
  card.innerHTML = `
    <b>${d.sym}</b>

    <div class="muted ${dominantColor}">
      üß≠ Overall Dominant: <b>${d.overallDominant}</b>
    </div>

    <div class="muted ${activeLevelColor}" style="margin-top:4px">
      üéØ <b>Current Structure Test:</b> ${d.levelType}
    </div>

    <div class="prob ${biasColor}">
      ${d.bias} ‚Äî ${d.prob}% <span class="muted">(Structure Bias)</span>
    </div>

    <div class="muted ${changeColor}">
      24h Change: <b>${d.change.toFixed(2)}%</b>
    </div>

    <div class="muted ${d.dominantBull ? "bull" : "bear"}">
      üìä Dominant 24h Volume:
      <b>${Number(d.dominantVol).toLocaleString()}</b><br>
      ${volumeLabel}
    </div>

    <div class="muted ${dailyCloseColor}" style="margin-top:4px">
      üìÖ <b>Daily Close Bias:</b> ${dailyCloseBias}
    </div>

    ${d.supportLevels?.length ? `
      <div class="muted bear" style="margin-top:6px">
        üî¥ <b>Support</b>
        <br>‚Ä¢ S1: <b>${d.supportLevels[0].toFixed(4)}</b>
        (${d.supportDistances[0].toFixed(2)}%)
        ${d.supportLevels[1] ? `
          <br>‚Ä¢ S2: <b>${d.supportLevels[1].toFixed(4)}</b>
          (${d.supportDistances[1].toFixed(2)}%)
        ` : ``}
      </div>
    ` : ``}

    ${d.resistanceLevels?.length ? `
      <div class="muted bull" style="margin-top:6px">
        üü¢ <b>Resistance</b>
        <br>‚Ä¢ R1: <b>${d.resistanceLevels[0].toFixed(4)}</b>
        (${d.resistanceDistances[0].toFixed(2)}%)
        ${d.resistanceLevels[1] ? `
          <br>‚Ä¢ R2: <b>${d.resistanceLevels[1].toFixed(4)}</b>
          (${d.resistanceDistances[1].toFixed(2)}%)
        ` : ``}
      </div>
    ` : ``}

    <div class="muted" style="margin-top:6px">
      ${d.reasons.join(" ‚Ä¢ ")}
    </div>
  `;
}
  
  

/* ================= SCAN ================= */
async function runScan(){
  if(scanRunning) return;
  scanRunning = true;

  setTimeout(()=>{
  if(scanRunning){
    console.warn("‚ö†Ô∏è Scan watchdog unlock");
    scanRunning = false;
    status.innerText = "Scan recovered";
  }
}, 55_000);

  progressFill.style.width = "0%";
  status.innerText = isAuto ? "Auto refreshing..." : "Scanning...";

  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt=t.filter(x=>x.symbol.endsWith("USDT")&&!BLACKSET.has(x.symbol));

  const g=[...usdt].sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const r=[...usdt].sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);

  const total=g.length+r.length;
  let done=0;

  for(const x of g){
    const dd=(x.lastPrice-x.highPrice)/x.highPrice*100;
    const res=await analyze(x.symbol,false,dd);
    res.change=+x.priceChangePercent;
    if(res.prob>=80) alertSound.play();
    renderCard(res,greenGrid);
    done++;
    progressFill.style.width=Math.round(done/total*100)+"%";
  }

  for(const x of r){
    const dd=(x.lastPrice-x.highPrice)/x.highPrice*100;
    const res=await analyze(x.symbol,true,dd);
    res.change=+x.priceChangePercent;
    renderCard(res,redGrid);
    done++;
    progressFill.style.width=Math.round(done/total*100)+"%";
  }

  timestamp.innerText=new Date().toLocaleString();
  status.innerText="Completed";
  scanRunning = false;   // ‚úÖ unlock
  applyFilters();
      }

/* ================= MANUAL SEARCH ================= */
async function runSearch(){
  const sym = symbolSearch.value.trim().toUpperCase();
  if(!sym) return;

  const fullSym = sym.endsWith("USDT") ? sym : (sym + "USDT");
  if(BLACKSET.has(fullSym)) return;

  try{
    status.innerText = `Analyzing ${fullSym}...`;
    searchGrid.innerHTML = "";

    const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${fullSym}`);

    const dChange = +t.priceChangePercent;
    const dd = ((+t.lastPrice - +t.highPrice) / +t.highPrice) * 100;
    const bear = dChange < 0;

    const r = await analyze(fullSym, bear, dd, dChange);
    r.change = dChange;

    // ‚úÖ FORCE render even if structure is NOT weak
    renderCard(r, searchGrid, true);
applyFilters();

    status.innerText = `Done: ${fullSym}`;
  }catch(err){
    console.error(err);
    status.innerText = `Error analyzing ${fullSym}`;
    searchGrid.innerHTML = `
      <div class="card">
        <b>${fullSym}</b>
        <div class="muted bear">Failed to analyze or no data.</div>
      </div>`;
  }
}

  function applyFilters(){
  const fStructure = document.getElementById("filterStructure").value;
  const fBias = document.getElementById("filterBias").value;
  const fChange = document.getElementById("filterChange").value;
  const fProb = Number(document.getElementById("filterProb").value);
  const fLevelState = document.getElementById("filterLevelState").value;
  const fDailyClose = document.getElementById("filterDailyClose")?.value || "all";

  const cards = document.querySelectorAll(
    "#greenGrid .card, #redGrid .card, #searchGrid .card"
  );

  cards.forEach(card=>{
    let show = true;

    if(fStructure !== "all" && card.dataset.structure !== fStructure) show = false;
    if(fBias !== "all" && card.dataset.bias !== fBias) show = false;
    if(fChange !== "all" && card.dataset.change !== fChange) show = false;
    if(Number(card.dataset.prob) < fProb) show = false;
    if(fLevelState !== "all" && card.dataset.levelState !== fLevelState) show = false;
    if(fDailyClose !== "all" && card.dataset.dailyClose !== fDailyClose) show = false;

    card.style.display = show ? "" : "none";
  });
}

  function resetFilters(){
  document.getElementById("filterStructure").value = "all";
  document.getElementById("filterBias").value = "all";
  document.getElementById("filterChange").value = "all";
  document.getElementById("filterProb").value = "0";
  document.getElementById("filterLevelState").value = "all";
  document.getElementById("filterDailyClose").value = "all";

  applyFilters();
}
  
</script>
</body>
</html>
