<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Bull / Bear Probability ‚Äî Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#334155;
  border:0;
  cursor:pointer;
}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:12px;
  margin-top:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.prob{font-weight:700}

/* progress bar */
.progress-wrap{margin:8px 0 10px}
.progress-bar{
  height:10px;
  background:#172033;
  border-radius:6px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:#22c55e;
  transition:width .2s linear;
}
</style>
</head>

<body>

<h1>üìä 15m Bull / Bear Probability ‚Äî Pro Scanner</h1>
<div class="muted" id="status">Idle</div>
<div class="muted" id="refreshTimer">Auto refresh: OFF</div>

<div class="progress-wrap">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <div class="muted" id="progressText">0%</div>
</div>

<div class="row">
  <button class="primary" onclick="runScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto Refresh</button>
  <div class="muted" id="timestamp"></div>
</div>

<div class="row">
  <input id="symbolSearch" placeholder="Search symbol (BTCUSDT)" />
  <button class="secondary" onclick="runSearch()">Analyze</button>
</div>

<h2>üü¢ Top 30 GREEN</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Top 30 RED</h2>
<div class="grid" id="redGrid"></div>

<h2>üîç Manual Analysis</h2>
<div class="grid" id="searchGrid"></div>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= DOM ================= */
const greenGrid = document.getElementById("greenGrid");
const redGrid   = document.getElementById("redGrid");
const searchGrid= document.getElementById("searchGrid");
const status    = document.getElementById("status");
const timestamp = document.getElementById("timestamp");
const symbolSearch = document.getElementById("symbolSearch");
const alertSound = document.getElementById("alertSound");
const progressFill = document.getElementById("progressFill");
const progressText = document.getElementById("progressText");
const refreshTimer = document.getElementById("refreshTimer");

/* ================= CONFIG ================= */
const API = "https://fapi.binance.com";
const DELAY = 300;
const AUTO_INTERVAL = 5 * 60 * 1000;

const BLACKSET = new Set([
 "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT",
 "LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT",
 "OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT",
 "NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","MEMEFIUSDT",
 "NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT",
 "COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
 "MYROUSDT","1000XUSDT","DARUSDT","PORT3USDT","SKATEUSDT",
 "AIAUSDT","AMBUSDT","FLMUSDT","PERPUSDT","OBOLUSDT"
]);

/* ================= AUTO REFRESH TIMER ================= */
let autoEnabled = false;
let autoTimer = null;
let countdownTimer = null;
let nextRefreshAt = 0;

function startCountdown(){
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    const diff = nextRefreshAt - Date.now();
    if(diff <= 0){
      refreshTimer.innerText = "Refreshing now...";
      return;
    }
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);
    refreshTimer.innerText =
      `Next refresh in: ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  },1000);
}

function toggleAuto(){
  autoEnabled = !autoEnabled;

  if(autoEnabled){
    runScan();
    nextRefreshAt = Date.now() + AUTO_INTERVAL;

    autoTimer = setInterval(()=>{
      runScan();
      nextRefreshAt = Date.now() + AUTO_INTERVAL;
    }, AUTO_INTERVAL);

    startCountdown();
  }else{
    clearInterval(autoTimer);
    clearInterval(countdownTimer);
    refreshTimer.innerText = "Auto refresh: OFF";
  }
  }

/* ================= HELPERS ================= */

const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("Fetch failed");
  return r.json();
}

function ema(vals,p){
  const k = 2/(p+1);
  let e = vals[0];
  for(let i=1;i<vals.length;i++) e = vals[i]*k + e*(1-k);
  return e;
}

function rsi(c,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    const d=c[i]-c[i-1];
    d>0?g+=d:l-=d;
  }
  let rs=g/(l||1), r=100-(100/(1+rs));
  for(let i=p+1;i<c.length;i++){
    const d=c[i]-c[i-1];
    if(d>0){g=(g*(p-1)+d)/p;l=(l*(p-1))/p;}
    else{g=(g*(p-1))/p;l=(l*(p-1)-d)/p;}
    rs=g/(l||1); r=100-(100/(1+rs));
  }
  return r;
}

function atr(h,l,c,p=14){
  let trs=[];
  for(let i=1;i<c.length;i++){
    trs.push(Math.max(
      h[i]-l[i],
      Math.abs(h[i]-c[i-1]),
      Math.abs(l[i]-c[i-1])
    ));
  }
  return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
}

/* ================= ANALYSIS (15m ONLY) ================= */

async function analyze(sym,bear=false,drawdown=null){
  const k15 = await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=120`);
  await sleep(DELAY);

  const c = k15.map(k=>+k[4]);
  const o = k15.map(k=>+k[1]);
  const h = k15.map(k=>+k[2]);
  const l = k15.map(k=>+k[3]);
  const v = k15.map(k=>+k[5]);
  const last = k15[k15.length-1];

  const avgVol = v.slice(-40).reduce((a,b)=>a+b,0)/40;

  const emaNow  = ema(c.slice(-60),50);
  const emaPrev = ema(c.slice(-65,-5),50);
  const emaSlope = emaNow - emaPrev;

  const rNow  = rsi(c);
  const rPrev = rsi(c.slice(0,-1));

  const atrNow  = atr(h,l,c);
  const atrPrev = atr(h.slice(0,-1),l.slice(0,-1),c.slice(0,-1));

  const body = Math.abs(last[4]-last[1]);
  const range = last[2]-last[3];
  const bodyRatio = range ? body/range : 0;

  const high20 = Math.max(...h.slice(-20));
  const low20  = Math.min(...l.slice(-20));
  const rangePos = (last[4]-low20)/(high20-low20||1);

  let s=0, rs=[];

  /* === CORE MOMENTUM === */
  if(!bear){
    if(last[4] > emaNow){s++;rs.push("Above EMA50");}
    if(last[4] > c[c.length-2]){s++;rs.push("Acceptance");}
    if(rNow > 50){s++;rs.push("RSI > 50");}
    if(last[5] > avgVol){s++;rs.push("Volume Confirmed");}
  }else{
    if(last[4] < emaNow){s++;rs.push("Below EMA50");}
    if(last[4] < c[c.length-2]){s++;rs.push("Rejection");}
    if(rNow < 50){s++;rs.push("RSI < 50");}
    if(last[5] > avgVol){s++;rs.push("Sell Volume");}
  }

  /* === DRAWNDOWN CONTEXT === */
  if(typeof drawdown==="number"){
    if(!bear){
      if(drawdown >= -1){s++;rs.push("Strong Acceptance");}
      else if(drawdown <= -7){s-=2;rs.push("Distribution Risk");}
      else if(drawdown <= -4){s--;rs.push("Weak Pullback");}
    }else{
      if(drawdown <= -1){s++;rs.push("Sell Pressure");}
      else{s--;rs.push("Bear Rejection");}
    }
  }

  /* === ADVANCED 15m CONFIRMATIONS === */
  if(!bear && emaSlope>0){s++;rs.push("EMA Rising");}
  if(bear && emaSlope<0){s++;rs.push("EMA Falling");}

  if(!bear && rNow>rPrev){s++;rs.push("RSI Rising");}
  if(bear && rNow<rPrev){s++;rs.push("RSI Falling");}

  if(bodyRatio>0.6){s++;rs.push("Strong Candle Close");}

  if(atrNow>atrPrev){s++;rs.push("Volatility Expanding");}

  if(!bear && rangePos>0.3 && rangePos<0.8){s++;rs.push("Healthy Range");}
  if(bear && rangePos<0.7 && rangePos>0.2){s++;rs.push("Bear Range");}

  s = Math.max(0,Math.min(MAX_SCORE,s));
  const p = Math.round((s/MAX_SCORE)*100);

  const bias =
    p>=80?(bear?"Strong Bear":"Strong Bull"):
    p>=60?(bear?"Weak Bear":"Weak Bull"):
    p>=40?"Neutral":
    (bear?"Weak Bull":"Weak Bear");

  return {sym,prob:p,bias,reasons:rs,drawdown};
}

/* ================= MAIN ================= */

    async function runScan(){
  greenGrid.innerHTML="";
  redGrid.innerHTML="";
  status.innerText="Scanning...";

  progressFill.style.width="0%";
  progressText.innerText="0%";

  const t = await fetch(`${API}/fapi/v1/ticker/24hr`).then(r=>r.json());
  const usdt = t.filter(x=>x.symbol.endsWith("USDT"));

  const green = usdt.sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const red   = usdt.sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);

  const total = green.length + red.length;
  let done = 0;

  const step = ()=>{
    done++;
    const pct = Math.round(done/total*100);
    progressFill.style.width=pct+"%";
    progressText.innerText=`${pct}% (${done}/${total})`;
  };

  for(const x of green){
    await sleep(DELAY);
    renderCard(x.symbol,x.priceChangePercent,greenGrid);
    step();
  }
  for(const x of red){
    await sleep(DELAY);
    renderCard(x.symbol,x.priceChangePercent,redGrid);
    step();
  }

  timestamp.innerText=new Date().toLocaleString();
  status.innerText="Completed";
}

function renderCard(sym,chg,el){
  const cls = chg>=0?"bull":"bear";
  const sign = chg>=0?"+":"";
  el.innerHTML+=`
  <div class="card">
    <b>${sym}</b>
    <div class="muted ${cls}">
      24h Change: ${sign}${(+chg).toFixed(2)}%
    </div>
  </div>`;
}

const sleep = ms => new Promise(r=>setTimeout(r,ms));
</script>
</body>
</html>
