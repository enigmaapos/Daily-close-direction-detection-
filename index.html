<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Bull / Bear Probability â€” Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
}
button.secondary{
  background:#334155;
  border:0;
}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:12px;
  margin-top:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.trade{color:#38bdf8;font-weight:700}
.no-trade{color:#94a3b8}
.prob{font-weight:700}

.progress-wrap{margin:8px 0 10px}
.progress-bar{
  height:10px;
  background:#172033;
  border-radius:6px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:#22c55e;
}
</style>
</head>

<body>

<h1>ðŸ“Š 15m Bull / Bear Probability â€” Pro Scanner</h1>
<div class="muted" id="status">Idle</div>

<div class="progress-wrap">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="row">
  <button class="primary" onclick="runScan()">Run Scan</button>
</div>

<h2>ðŸŸ¢ Top 30 GREEN</h2>
<div class="grid" id="greenGrid"></div>

<h2>ðŸ”´ Top 30 RED</h2>
<div class="grid" id="redGrid"></div>

<script>
const API="https://fapi.binance.com";
const MAX_SCORE=8;
const DELAY=200;

const greenGrid=document.getElementById("greenGrid");
const redGrid=document.getElementById("redGrid");
const progressFill=document.getElementById("progressFill");
const status=document.getElementById("status");

const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fetchJSON=async u=>(await fetch(u)).json();

function ema(v,p){
  const k=2/(p+1);
  let e=v[0];
  for(let i=1;i<v.length;i++) e=v[i]*k+e*(1-k);
  return e;
}
function rsi(c,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    const d=c[i]-c[i-1];
    d>0?g+=d:l-=d;
  }
  let rs=g/(l||1);
  let r=100-(100/(1+rs));
  for(let i=p+1;i<c.length;i++){
    const d=c[i]-c[i-1];
    if(d>0){g=(g*(p-1)+d)/p;l=(l*(p-1))/p;}
    else{g=(g*(p-1))/p;l=(l*(p-1)-d)/p;}
    rs=g/(l||1);
    r=100-(100/(1+rs));
  }
  return r;
}
function atr(h,l,c,p=14){
  let t=[];
  for(let i=1;i<c.length;i++)
    t.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])));
  return t.slice(-p).reduce((a,b)=>a+b,0)/p;
}

async function analyze(sym,bear){
  const k=await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=120`);
  await sleep(DELAY);

  const c=k.map(x=>+x[4]);
  const h=k.map(x=>+x[2]);
  const l=k.map(x=>+x[3]);
  const v=k.map(x=>+x[5]);
  const last=k[k.length-1];

  let dominantVol=0, dominantBull=true;
  for(let i=k.length-96;i<k.length;i++){
    if(v[i]>dominantVol){
      dominantVol=v[i];
      dominantBull=k[i][4]>k[i][1];
    }
  }

  const avgV=v.slice(-40).reduce((a,b)=>a+b,0)/40;
  const eNow=ema(c.slice(-60),50);
  const ePrev=ema(c.slice(-65,-5),50);
  const rNow=rsi(c);
  const rPrev=rsi(c.slice(0,-1));
  const aNow=atr(h,l,c);
  const aPrev=atr(h.slice(0,-1),l.slice(0,-1),c.slice(0,-1));

  const body=Math.abs(last[4]-last[1]);
  const range=last[2]-last[3];
  const bodyR=range?body/range:0;

  const hi=Math.max(...h.slice(-20));
  const lo=Math.min(...l.slice(-20));
  const pos=(last[4]-lo)/(hi-lo||1);

  let s=0, reasons=[];

  if(!bear && last[4]>eNow){s++;reasons.push("Above EMA50")}
  if(bear && last[4]<eNow){s++;reasons.push("Below EMA50")}

  if(!bear && eNow>ePrev){s++;reasons.push("EMA Rising")}
  if(bear && eNow<ePrev){s++;reasons.push("EMA Falling")}

  if(!bear && rNow>50){s++;reasons.push("RSI > 50")}
  if(bear && rNow<50){s++;reasons.push("RSI < 50")}

  if(!bear && rNow>rPrev){s++;reasons.push("RSI Rising")}
  if(bear && rNow<rPrev){s++;reasons.push("RSI Falling")}

  if(bodyR>0.6){s++;reasons.push("Strong Candle")}
  if(last[5]>avgV){s++;reasons.push("Volume")}
  if(aNow>aPrev){s++;reasons.push("Volatility Expansion")}

  s=Math.min(MAX_SCORE,s);
  const baseProb=Math.round(s/MAX_SCORE*100);

  let finalProb=baseProb;
  let volumeAlign="neutral";

  if((!bear && dominantBull)||(bear && !dominantBull)){
    finalProb+=10;
    volumeAlign="confirm";
  }else{
    finalProb-=5;
    volumeAlign="contradict";
  }

  finalProb=Math.max(0,Math.min(100,finalProb));

  let exhaustion=0;
  if(rNow>75||rNow<25) exhaustion+=25;
  if(pos>0.9||pos<0.1) exhaustion+=25;
  if(volumeAlign==="contradict") exhaustion+=20;
  if(bodyR<0.3) exhaustion+=15;
  exhaustion=Math.min(100,exhaustion);

  const continuation=Math.max(0,100-exhaustion);

  let bias="Neutral";
  if(!bear){
    if(finalProb>=75) bias="Strong Bull";
    else if(finalProb>=55) bias="Weak Bull";
  }else{
    if(finalProb>=75) bias="Strong Bear";
    else if(finalProb>=55) bias="Weak Bear";
  }

  const tradeAllowed=
    baseProb>=60 &&
    finalProb>=70 &&
    volumeAlign==="confirm" &&
    exhaustion<=40;

  return {
    sym, bias, baseProb, finalProb,
    continuation, exhaustion,
    tradeAllowed, dominantVol, dominantBull,
    reasons
  };
}

function render(d,el){
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`
    <b>${d.sym}</b>
    <div class="prob ${d.bias.includes("Bull")?"bull":d.bias.includes("Bear")?"bear":"neutral"}">
      ${d.bias} â€” ${d.finalProb}% <span class="muted">(base ${d.baseProb}%)</span>
    </div>
    <div class="muted ${d.dominantBull?"bull":"bear"}">
      Dominant Volume: ${Number(d.dominantVol).toLocaleString()}
    </div>
    <div class="muted">Continuation: ${d.continuation}%</div>
    <div class="muted">Exhaustion: ${d.exhaustion}%</div>
    <div class="${d.tradeAllowed?"trade":"no-trade"}">
      ${d.tradeAllowed?"TRADE ALLOWED":"NO TRADE â€” WAIT"}
    </div>
    <div class="muted">${d.reasons.join(" â€¢ ")}</div>
  `;
  el.appendChild(card);
}

async function runScan(){
  status.innerText="Scanning...";
  greenGrid.innerHTML=""; redGrid.innerHTML="";
  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt=t.filter(x=>x.symbol.endsWith("USDT"));
  const g=[...usdt].sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const r=[...usdt].sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);

  let done=0,total=g.length+r.length;

  for(const x of g){
    const d=await analyze(x.symbol,false);
    render(d,greenGrid);
    progressFill.style.width=++done/total*100+"%";
  }
  for(const x of r){
    const d=await analyze(x.symbol,true);
    render(d,redGrid);
    progressFill.style.width=++done/total*100+"%";
  }
  status.innerText="Completed";
}
</script>
</body>
</html>
