<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>15m Strong Bull Probability ‚Äî Pro Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button,input{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0b1220;
  color:#e6eef8;
}
button.primary{
  background:#22c55e;
  border:0;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#334155;
  border:0;
  cursor:pointer;
}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:12px;
  margin-top:10px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.prob{font-weight:700}
</style>
</head>
<body>

<h1>üìä 15m Strong Bull Probability ‚Äî Pro Scanner</h1>
<div class="muted" id="status">Idle</div>

<div class="row">
  <button class="primary" onclick="runScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto Refresh</button>
  <div class="muted" id="timestamp"></div>
</div>

<div class="row">
  <input id="symbolSearch" placeholder="Search symbol (BTCUSDT)" />
  <button class="secondary" onclick="runSearch()">Analyze</button>
</div>

<h2>üü¢ Top 30 GREEN ‚Äî Weak Bear Only</h2>
<div class="grid" id="greenGrid"></div>

<h2>üî¥ Top 30 RED ‚Äî Weak Bull Only</h2>
<div class="grid" id="redGrid"></div>

<h2>üîç Manual Analysis (All Results)</h2>
<div class="grid" id="searchGrid"></div>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= DOM ================= */

const greenGrid = document.getElementById("greenGrid");
const redGrid = document.getElementById("redGrid");
const searchGrid = document.getElementById("searchGrid");
const status = document.getElementById("status");
const timestamp = document.getElementById("timestamp");
const symbolSearch = document.getElementById("symbolSearch");
const alertSound = document.getElementById("alertSound");

/* ================= STATE ================= */

const cardIndex = new Map();
let autoTimer = null;

/* ================= CONFIG ================= */

const API = "https://fapi.binance.com";
const DELAY = 300;
const AUTO_INTERVAL = 5 * 60 * 1000;

const BLACKSET = new Set([
  "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT",
  "LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT",
  "OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT",
  "NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","MEMEFIUSDT",
  "NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT",
  "COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
  "MYROUSDT","1000XUSDT","DARUSDT","PORT3USDT","SKATEUSDT",
  "AIAUSDT","AMBUSDT","FLMUSDT","PERPUSDT","OBOLUSDT"
]);

/* ================= HELPERS ================= */

const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("Fetch failed");
  return r.json();
}

function ema(vals,p){
  const k = 2/(p+1);
  let e = vals[0];
  for(let i=1;i<vals.length;i++) e = vals[i]*k + e*(1-k);
  return e;
}

function rsi(c,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    const d=c[i]-c[i-1];
    d>0?g+=d:l-=d;
  }
  let rs=g/(l||1), r=100-(100/(1+rs));
  for(let i=p+1;i<c.length;i++){
    const d=c[i]-c[i-1];
    if(d>0){g=(g*(p-1)+d)/p;l=(l*(p-1))/p;}
    else{g=(g*(p-1))/p;l=(l*(p-1)-d)/p;}
    rs=g/(l||1); r=100-(100/(1+rs));
  }
  return r;
}

/* ================= ANALYSIS ================= */

async function analyze(sym, bear=false, drawdown=null){
  const k15 = await fetchJSON(
    `${API}/fapi/v1/klines?symbol=${sym}&interval=15m&limit=120`
  );
  await sleep(DELAY);

  const c = k15.map(k=>+k[4]);
  const v = k15.map(k=>+k[5]);
  const last = k15[k15.length-1];

  const avgVol = v.slice(-40).reduce((a,b)=>a+b,0)/40;
  const emaTF = ema(c.slice(-60),50);
  const r = rsi(c);

  let s=0, rs=[];

  if(!bear){
    if(+last[4] > emaTF){s++;rs.push("Above 15m EMA");}
    if(+last[4] > +k15[k15.length-2][4]){s++;rs.push("15m Acceptance");}
    if(r > 50){s++;rs.push("RSI > 50");}
    if(+last[5] > avgVol){s++;rs.push("Volume Confirmed");}
  } else {
    if(+last[4] < emaTF){s++;rs.push("Below 15m EMA");}
    if(+last[4] < +k15[k15.length-2][4]){s++;rs.push("15m Rejection");}
    if(r < 50){s++;rs.push("RSI < 50");}
    if(+last[5] > avgVol){s++;rs.push("Sell Volume");}
  }

  if(typeof drawdown === "number"){
    if(!bear){
      if(drawdown >= -1){s++;rs.push("Strong Acceptance");}
      else if(drawdown <= -7){s-=2;rs.push("Distribution Risk");}
      else if(drawdown <= -4){s--;rs.push("Weak Pullback");}
    } else {
      if(drawdown <= -1){s++;rs.push("Strong Sell Pressure");}
      else{s--;rs.push("Bear Rejection");}
    }
  }

  s = Math.max(0, Math.min(5, s));
  const p = s * 20;

  const bias =
    s>=4?(bear?"Strong Bear":"Strong Bull"):
    s===3?(bear?"Weak Bear":"Weak Bull"):
    s===2?"Neutral":
    (bear?"Weak Bull":"Weak Bear");

  return {sym,prob:p,bias,reasons:rs};
}

/* ================= MAIN ================= */

async function runScan(){
  status.innerText="Scanning...";
  greenGrid.innerHTML="";
  redGrid.innerHTML="";

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt = t.filter(x=>x.symbol.endsWith("USDT")&&!BLACKSET.has(x.symbol));

  /* üü¢ TOP 30 GREEN ‚Üí Weak Bear ONLY */
  for(const x of usdt
    .sort((a,b)=>b.priceChangePercent-a.priceChangePercent)
    .slice(0,30)
  ){
    const dd=((+x.lastPrice-+x.highPrice)/+x.highPrice)*100;
    const r=await analyze(x.symbol,false,dd);
    r.drawdown=dd;
    if(r.bias==="Weak Bear"){
      renderCard(r,greenGrid);
    }
  }

  /* üî¥ TOP 30 RED ‚Üí Weak Bull ONLY */
  for(const x of usdt
    .sort((a,b)=>a.priceChangePercent-b.priceChangePercent)
    .slice(0,30)
  ){
    const dd=((+x.lastPrice-+x.highPrice)/+x.highPrice)*100;
    const r=await analyze(x.symbol,true,dd);
    r.drawdown=dd;
    if(r.bias==="Weak Bull"){
      renderCard(r,redGrid);
    }
  }

  timestamp.innerText=new Date().toLocaleString();
  status.innerText="Completed";
}

async function runSearch(){
  const sym=symbolSearch.value.trim().toUpperCase();
  if(!sym.endsWith("USDT")||BLACKSET.has(sym)) return;
  searchGrid.innerHTML="";
  const t=await fetchJSON(`${API}/fapi/v1/ticker/24hr?symbol=${sym}`);
  const dd=((+t.lastPrice-+t.highPrice)/+t.highPrice)*100;
  const bear=+t.priceChangePercent<0;
  const r=await analyze(sym,bear,dd);
  r.drawdown=dd;
  renderCard(r,searchGrid);
}

function toggleAuto(){
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer=null;
    status.innerText="Auto refresh stopped";
    return;
  }
  runScan();
  autoTimer=setInterval(runScan,AUTO_INTERVAL);
  status.innerText="Auto refresh running";
}

/* ================= UI ================= */

function renderCard(d, el){
  let card = cardIndex.get(d.sym);

  let probClass = d.bias.includes("Bull") ? "bull" :
                  d.bias.includes("Bear") ? "bear" : "neutral";

  let ddClass = d.drawdown >= -1 ? "bull" :
                d.drawdown <= -4 ? "bear" : "neutral";

  if(!card){
    card=document.createElement("div");
    card.className="card";
    cardIndex.set(d.sym,card);
  }

  if(card.parentNode!==el) el.appendChild(card);

  card.innerHTML=`
    <b>${d.sym}</b>
    <div class="prob ${probClass}">
      ${d.bias} ‚Äî ${d.prob}%
    </div>
    <div class="muted ${ddClass}">
      24h Drawdown: ${d.drawdown.toFixed(2)}%
    </div>
    <div class="muted">
      ${d.reasons.join(" ‚Ä¢ ")}
    </div>
  `;
}
</script>
</body>
</html>
