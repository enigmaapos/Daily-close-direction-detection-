<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>1D Bull / Bear Probability â€” Top 30 Movers</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:Inter,system-ui,Arial;
  background:#0f1720;
  color:#e6eef8;
  margin:16px;
}
h1{font-size:18px;margin-bottom:6px}
h2{font-size:16px;margin-top:14px}
.muted{color:#9fb3cc;font-size:13px}
button{
  padding:8px 14px;
  background:#22c55e;
  border:0;
  border-radius:6px;
  color:#042e16;
  font-weight:700;
  cursor:pointer;
}
button.secondary{background:#334155;color:#e6eef8}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:12px;
  margin-top:12px;
}
.card{
  background:#0b1220;
  border:1px solid #172033;
  border-radius:10px;
  padding:12px;
}
.bull{color:#22c55e}
.bear{color:#fb7185}
.neutral{color:#facc15}
.prob{font-weight:700}
</style>
</head>
<body>

<h1>ðŸ“Š Daily Bull / Bear Probability â€” Top 30 Movers</h1>
<div class="muted" id="status">Idle</div>

<div class="row">
  <button onclick="runScan()">Run Scan</button>
  <button class="secondary" onclick="toggleAuto()">Auto Refresh</button>
  <div class="muted" id="timestamp"></div>
</div>

<h2>ðŸŸ¢ Top 30 GREEN (Bullish Bias)</h2>
<div class="grid" id="greenGrid"></div>

<h2>ðŸ”´ Top 30 RED (Bearish Bias)</h2>
<div class="grid" id="redGrid"></div>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ================= CONFIG ================= */

const API = 'https://fapi.binance.com';
const DELAY = 550;
const AUTO_INTERVAL = 5 * 60 * 1000;

const BLACKLIST = [
  "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT",
  "LINAUSDT","LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT",
  "OMNIUSDT","SLERFUSDT","STMXUSDT","UXLINKUSDT","BSWUSDT",
  "NEIROETHUSDT","VIDTUSDT","TROYUSDT","BAKEUSDT","MEMEFIUSDT",
  "NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT","STRAXUSDT",
  "COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
  "MYROUSDT","1000XUSDT","DARUSDT"
];
const BLACKSET = new Set(BLACKLIST);

/* ================= STATE ================= */

let autoTimer = null;
let alertPlayed = false;

/* ================= HELPERS ================= */

const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('Fetch failed');
  return r.json();
}

function ema(values, p){
  const k = 2/(p+1);
  let e = values[0];
  for(let i=1;i<values.length;i++) e = values[i]*k + e*(1-k);
  return e;
}

function rsi(closes, p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    const d = closes[i]-closes[i-1];
    if(d>0) g+=d; else l-=d;
  }
  let rs = g/(l||1);
  let r = 100-(100/(1+rs));
  for(let i=p+1;i<closes.length;i++){
    const d = closes[i]-closes[i-1];
    if(d>0){ g=(g*(p-1)+d)/p; l=(l*(p-1))/p; }
    else{ g=(g*(p-1))/p; l=(l*(p-1)-d)/p; }
    rs = g/(l||1);
    r = 100-(100/(1+rs));
  }
  return r;
}

/* ================= ANALYSIS ================= */

async function getDailyOpen(sym){
  const d = await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=1d&limit=1`);
  await sleep(DELAY);
  return +d[0][1];
}

async function analyze(sym, bearish=false){
  const k4 = await fetchJSON(`${API}/fapi/v1/klines?symbol=${sym}&interval=4h&limit=60`);
  await sleep(DELAY);

  const dailyOpen = await getDailyOpen(sym);
  const closes = k4.map(k=>+k[4]);
  const vols = k4.map(k=>+k[5]);
  const last = k4[k4.length-1];
  const emaHTF = ema(closes.slice(-40),20);
  const r = rsi(closes);
  const avgVol = vols.slice(-20).reduce((a,b)=>a+b,0)/20;

  let score = 0;
  let reasons = [];

  if(!bearish){
    if(+last[4] > dailyOpen){score++;reasons.push("Above Daily Open");}
    if(+last[4] > emaHTF){score++;reasons.push("Above HTF EMA");}
    if(+last[4] > +k4[k4.length-2][4]){score++;reasons.push("Acceptance Up");}
    if(r > 50){score++;reasons.push("RSI > 50");}
    if(+last[5] > avgVol){score++;reasons.push("Volume Confirmed");}
  } else {
    if(+last[4] < dailyOpen){score++;reasons.push("Below Daily Open");}
    if(+last[4] < emaHTF){score++;reasons.push("Below HTF EMA");}
    if(+last[4] < +k4[k4.length-2][4]){score++;reasons.push("Acceptance Down");}
    if(r < 50){score++;reasons.push("RSI < 50");}
    if(+last[5] > avgVol){score++;reasons.push("Sell Volume");}
  }

  const prob = score * 20;
  let bias = score>=4 ? (bearish?"Strong Bear":"Strong Bull")
           : score===3 ? (bearish?"Weak Bear":"Weak Bull")
           : score===2 ? "Neutral"
           : (bearish?"Weak Bull":"Weak Bear");

  return {sym,prob,bias,reasons};
}

/* ================= UI ================= */

function render(list, el){
  el.innerHTML='';
  list.sort((a,b)=>b.prob-a.prob);
  list.forEach(d=>{
    const cls=d.bias.includes("Bull")?"bull":d.bias.includes("Bear")?"bear":"neutral";
    el.innerHTML+=`
      <div class="card">
        <b>${d.sym}</b>
        <div class="prob ${cls}">${d.bias} â€” ${d.prob}%</div>
        <div class="muted">${d.reasons.join(" â€¢ ")}</div>
      </div>`;
  });
}

/* ================= MAIN ================= */

async function runScan(){
  alertPlayed=false;
  document.getElementById('status').innerText='Scanning...';

  const t = await fetchJSON(`${API}/fapi/v1/ticker/24hr`);
  const usdt = t.filter(x=>x.symbol.endsWith("USDT")&&!BLACKSET.has(x.symbol));

  const green = usdt.sort((a,b)=>b.priceChangePercent-a.priceChangePercent).slice(0,30);
  const red   = usdt.sort((a,b)=>a.priceChangePercent-b.priceChangePercent).slice(0,30);

  const gRes=[], rRes=[];

  for(const x of green){
    const r = await analyze(x.symbol,false);
    if(r.prob>=80 && !alertPlayed){document.getElementById("alertSound").play();alertPlayed=true;}
    gRes.push(r);
  }

  for(const x of red){
    const r = await analyze(x.symbol,true);
    if(r.prob>=80 && !alertPlayed){document.getElementById("alertSound").play();alertPlayed=true;}
    rRes.push(r);
  }

  render(gRes, document.getElementById("greenGrid"));
  render(rRes, document.getElementById("redGrid"));

  document.getElementById("timestamp").innerText =
    "Last updated: "+new Date().toLocaleString();
  document.getElementById('status').innerText='Completed';
}

function toggleAuto(){
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer=null;
    document.getElementById("status").innerText="Auto refresh OFF";
  } else {
    runScan();
    autoTimer=setInterval(runScan,AUTO_INTERVAL);
    document.getElementById("status").innerText="Auto refresh ON (5m)";
  }
}
</script>
</body>
</html>
